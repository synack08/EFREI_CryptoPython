name: Industrialisation continue sur AlwaysData

on:
  push:
    branches: [ main ]           # adapte la branche si nÃ©cessaire

env:
  HOST: "ssh-${{ secrets.USERNAME }}.alwaysdata.net"

jobs:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. Connexion + dÃ©ploiement
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4        # on rÃ©cupÃ¨re le code (utile pour le nom du repo)

      - name: Connexion SSH et mise Ã  jour du code
        uses: appleboy/ssh-action@master
        with:
          host:     ${{ env.HOST }}
          username: ${{ secrets.USERNAME }}
          key:      ${{ secrets.ID_RSA }}
          port:     22
          debug:    true                 # Ã´te-le quand tout fonctionne
          script: |
            set -e
            cd $HOME/www

            repo=$(basename "${GITHUB_REPOSITORY}")
            branch="${{ github.ref_name }}"     # branche pushÃ©e, ex. main

            echo "=== DÃ©ploiement sur $repo ($branch) ==="

            # clone initial si besoin
            if [ ! -d "$repo" ]; then
              git clone --depth=1 --branch "$branch" \
                https://github.com/${GITHUB_REPOSITORY}.git
            fi

            cd "$repo"
            git pull origin "$branch"

            # ---- place ici tes commandes build / pip install etc. ----
            echo "ğŸ‰ Code mis Ã  jour"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. RedÃ©marrage du site AlwaysData
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Restart AlwaysData site
        run: |
          set -e
          SITE_ID=${{ secrets.ALWAYSDATA_SITE_ID }}
          TOKEN=${{ secrets.ALWAYSDATA_TOKEN }}

          echo "ğŸ”„ RedÃ©marrage du site $SITE_ID ..."
          code=$(curl -s -o /dev/null -w "%{http_code}" \
                  -X POST --user "${TOKEN}:" \
                  "https://api.alwaysdata.com/v1/site/${SITE_ID}/restart/")

          case "$code" in
            204) echo "âœ… Site relancÃ©" ;;
            404) echo "âŒ SITE_ID incorrect" && exit 1 ;;
            401) echo "âŒ TOKEN incorrect"    && exit 1 ;;
            *)   echo "âŒ Erreur API (code $code)" && exit 1 ;;
          esac
